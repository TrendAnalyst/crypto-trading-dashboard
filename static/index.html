<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrendScope</title>
    <meta name="description" content="Professional cryptocurrency trend analysis">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --bg: #000000;
            --bg-elevated: #0a0a0a;
            --bg-hover: #111111;
            --border: rgba(255, 255, 255, 0.06);
            --border-hover: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.5);
            --text-tertiary: rgba(255, 255, 255, 0.3);
            --accent: #0a84ff;
            --green: #30d158;
            --red: #ff453a;
            --radius: 12px;
            --radius-sm: 8px;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }
        
        /* Header */
        header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-bottom: 1px solid var(--border);
        }
        
        .header-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #0a84ff, #5e5ce6);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-icon svg {
            width: 18px;
            height: 18px;
            color: white;
        }
        
        .logo-text {
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.02em;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        /* Pill buttons */
        .pill-group {
            display: flex;
            background: var(--bg-elevated);
            border-radius: 10px;
            padding: 3px;
            border: 1px solid var(--border);
        }
        
        .pill-btn {
            padding: 6px 14px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            border-radius: 7px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .pill-btn:hover {
            color: var(--text-primary);
        }
        
        .pill-btn.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        
        /* Status badge */
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 13px;
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            background: var(--green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .status-count {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .status-label {
            color: var(--text-tertiary);
        }
        
        /* Main content */
        main {
            padding: 32px 0 100px;
        }
        
        /* Loading */
        #loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 120px 0;
        }
        
        .spinner {
            width: 32px;
            height: 32px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        #loading p {
            margin-top: 16px;
            color: var(--text-tertiary);
            font-size: 14px;
        }
        
        /* Error */
        #error {
            text-align: center;
            padding: 120px 24px;
        }
        
        #error h3 {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        #error p {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 24px;
        }
        
        .btn-primary {
            display: inline-flex;
            align-items: center;
            padding: 10px 20px;
            background: var(--accent);
            color: white;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: opacity 0.15s;
        }
        
        .btn-primary:hover {
            opacity: 0.9;
        }
        
        /* Table */
        .table-container {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: rgba(255, 255, 255, 0.02);
        }
        
        th {
            padding: 12px 20px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th.center { text-align: center; }
        th.right { text-align: right; }
        
        tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.15s ease;
        }
        
        tbody tr:last-child {
            border-bottom: none;
        }
        
        tbody tr:hover {
            background: var(--bg-hover);
        }
        
        td {
            padding: 16px 20px;
            font-size: 14px;
            vertical-align: middle;
        }
        
        td.center { text-align: center; }
        td.right { text-align: right; }
        
        /* Asset cell */
        .asset {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        
        .asset-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: white;
            transition: transform 0.2s ease;
        }
        
        tbody tr:hover .asset-icon {
            transform: scale(1.05);
        }
        
        .asset-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .asset-symbol {
            font-size: 12px;
            color: var(--text-tertiary);
            font-family: 'SF Mono', 'Menlo', monospace;
        }
        
        /* Score */
        .score {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        
        .score-value {
            font-size: 16px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }
        
        .score-value.positive { color: var(--green); }
        .score-value.negative { color: var(--red); }
        .score-value.neutral { color: var(--text-tertiary); }
        
        .score-bar {
            width: 60px;
            height: 3px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .score-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .score-fill.positive { background: var(--green); }
        .score-fill.negative { background: var(--red); }
        
        /* Trend indicator */
        .trend {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            transition: transform 0.15s ease;
        }
        
        tbody tr:hover .trend {
            transform: scale(1.1);
        }
        
        .trend.up {
            background: rgba(48, 209, 88, 0.12);
            color: var(--green);
        }
        
        .trend.down {
            background: rgba(255, 69, 58, 0.12);
            color: var(--red);
        }
        
        .trend.neutral {
            background: rgba(255, 255, 255, 0.04);
            color: var(--text-tertiary);
        }
        
        .trend svg {
            width: 14px;
            height: 14px;
        }
        
        /* Signal */
        .signal {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            transition: transform 0.15s ease;
        }
        
        .signal:hover {
            transform: translateY(-1px);
        }
        
        .signal.buy {
            background: rgba(48, 209, 88, 0.12);
            color: var(--green);
        }
        
        .signal.sell {
            background: rgba(255, 69, 58, 0.12);
            color: var(--red);
        }
        
        .signal-time {
            color: var(--text-tertiary);
            font-weight: 400;
        }
        
        .no-signal {
            color: var(--text-tertiary);
            font-size: 13px;
        }
        
        /* Updated time */
        .updated {
            font-size: 13px;
            color: var(--text-tertiary);
        }
        
        /* Footer */
        .footer {
            margin-top: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-tertiary);
        }
        
        .footer-legend {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .footer-legend span {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 2px;
        }
        
        .legend-dot.up { background: var(--green); }
        .legend-dot.down { background: var(--red); }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 16px; }
            .header-inner { height: 56px; }
            .pill-group { display: none; }
            th, td { padding: 12px 14px; }
            .asset-icon { width: 36px; height: 36px; font-size: 12px; }
        }
        
        /* Hidden class */
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-inner">
                <div class="logo">
                    <div class="logo-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                        </svg>
                    </div>
                    <span class="logo-text">TrendScope</span>
                </div>
                
                <div class="header-right">
                    <div class="pill-group">
                        <button class="pill-btn active" id="sort-bullish" onclick="sortCoins('score', 'desc')">Bullish</button>
                        <button class="pill-btn" id="sort-bearish" onclick="sortCoins('score', 'asc')">Bearish</button>
                        <button class="pill-btn" id="sort-name" onclick="sortCoins('name', 'asc')">A–Z</button>
                    </div>
                    
                    <div class="status">
                        <div class="status-dot"></div>
                        <span class="status-count" id="coin-count">0</span>
                        <span class="status-label">assets</span>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <main>
        <div class="container">
            <div id="loading">
                <div class="spinner"></div>
                <p>Loading</p>
            </div>
            
            <div id="error" class="hidden">
                <h3>Unable to connect</h3>
                <p>Please check your connection and try again.</p>
                <button class="btn-primary" onclick="fetchCoins()">Retry</button>
            </div>
            
            <div id="table-container" class="hidden">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Asset</th>
                                <th class="center" style="width:100px">Score</th>
                                <th class="center" style="width:70px">1W</th>
                                <th class="center" style="width:70px">3D</th>
                                <th class="center" style="width:70px">1D</th>
                                <th style="width:140px">Signal</th>
                                <th class="right" style="width:90px">Updated</th>
                            </tr>
                        </thead>
                        <tbody id="coins-table"></tbody>
                    </table>
                </div>
                
                <div class="footer">
                    <div class="footer-legend">
                        <span><div class="legend-dot up"></div>Uptrend</span>
                        <span><div class="legend-dot down"></div>Downtrend</span>
                        <span style="color: var(--text-tertiary)">Score: 1W ±6 · 3D ±3 · 1D ±1</span>
                    </div>
                    <div>
                        Updated <span id="last-update">—</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const REFRESH = 30000;
        let coins = [];
        let sort = { field: 'score', dir: 'desc' };

        const COLORS = {
            HYPE: 'linear-gradient(135deg, #8b5cf6, #a855f7)',
            VIRTUAL: 'linear-gradient(135deg, #06b6d4, #0ea5e9)',
            FARTCOIN: 'linear-gradient(135deg, #f59e0b, #f97316)',
            PEPE: 'linear-gradient(135deg, #22c55e, #16a34a)',
            DOGE: 'linear-gradient(135deg, #eab308, #f59e0b)',
            BTC: 'linear-gradient(135deg, #f97316, #ea580c)',
            ETH: 'linear-gradient(135deg, #6366f1, #8b5cf6)',
            SOL: 'linear-gradient(135deg, #9333ea, #c026d3)',
            DEFAULT: 'linear-gradient(135deg, #374151, #4b5563)'
        };

        function calcScore(t) {
            let s = 0;
            if (t['1w'] === 'uptrend') s += 6; else if (t['1w'] === 'downtrend') s -= 6;
            if (t['3d'] === 'uptrend') s += 3; else if (t['3d'] === 'downtrend') s -= 3;
            if (t['1d'] === 'uptrend') s += 1; else if (t['1d'] === 'downtrend') s -= 1;
            return s;
        }

        function sortCoins(field, dir) {
            sort = { field, dir };
            document.querySelectorAll('.pill-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(field === 'score' ? (dir === 'desc' ? 'sort-bullish' : 'sort-bearish') : 'sort-name')?.classList.add('active');
            render();
        }

        async function fetchCoins() {
            try {
                const res = await fetch('/api/coins');
                if (!res.ok) throw new Error();
                const data = await res.json();
                coins = data.coins.map(c => ({ ...c, score: calcScore(c.trends) }));
                document.getElementById('coin-count').textContent = data.total_coins;
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.add('hidden');
                document.getElementById('table-container').classList.remove('hidden');
                document.getElementById('last-update').textContent = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                render();
            } catch (e) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
            }
        }

        function render() {
            const sorted = [...coins].sort((a, b) => {
                if (sort.field === 'score') return sort.dir === 'desc' ? b.score - a.score : a.score - b.score;
                return a.display_name.localeCompare(b.display_name);
            });

            const tbody = document.getElementById('coins-table');
            const existing = {};
            tbody.querySelectorAll('tr').forEach(r => existing[r.id] = r);

            sorted.forEach(c => {
                const id = `r-${c.symbol.replace(/\./g, '')}`;
                let row = existing[id];
                if (!row) { row = document.createElement('tr'); row.id = id; tbody.appendChild(row); }

                const pct = Math.min(100, (Math.abs(c.score) / 10) * 100);
                const cls = c.score > 0 ? 'positive' : c.score < 0 ? 'negative' : 'neutral';
                const bg = COLORS[c.display_name] || COLORS.DEFAULT;

                row.innerHTML = `
                    <td>
                        <div class="asset">
                            <div class="asset-icon" style="background:${bg}">${c.display_name.slice(0,2)}</div>
                            <div>
                                <div class="asset-name">${c.display_name}</div>
                                <div class="asset-symbol">${c.symbol}</div>
                            </div>
                        </div>
                    </td>
                    <td class="center">
                        <div class="score">
                            <span class="score-value ${cls}">${c.score > 0 ? '+' : ''}${c.score}</span>
                            <div class="score-bar"><div class="score-fill ${cls}" style="width:${pct}%"></div></div>
                        </div>
                    </td>
                    <td class="center">${trend(c.trends['1w'])}</td>
                    <td class="center">${trend(c.trends['3d'])}</td>
                    <td class="center">${trend(c.trends['1d'])}</td>
                    <td>${signal(c.last_signal)}</td>
                    <td class="right"><span class="updated">${time(c.last_updated_minutes_ago)}</span></td>
                `;
                tbody.appendChild(row);
            });

            const ids = new Set(sorted.map(c => `r-${c.symbol.replace(/\./g, '')}`));
            Object.keys(existing).forEach(id => { if (!ids.has(id)) existing[id].remove(); });
        }

        function trend(t) {
            if (!t) return '<div class="trend neutral">–</div>';
            if (t === 'uptrend') return '<div class="trend up"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 15l7-7 7 7"/></svg></div>';
            return '<div class="trend down"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"/></svg></div>';
        }

        function signal(s) {
            if (!s?.type) return '<span class="no-signal">—</span>';
            const buy = s.type === 'buy';
            return `<div class="signal ${buy ? 'buy' : 'sell'}">${buy ? 'Buy' : 'Sell'}<span class="signal-time">${time(s.minutes_ago)}</span></div>`;
        }

        function time(m) {
            if (m == null) return '—';
            if (m < 1) return 'now';
            if (m < 60) return m + 'm';
            const h = Math.floor(m / 60);
            if (h < 24) return h + 'h';
            return Math.floor(h / 24) + 'd';
        }

        fetchCoins();
        setInterval(fetchCoins, REFRESH);
        document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') fetchCoins(); });
    </script>
</body>
</html>
